# **Lab 18: Azure Application Security Groups (ASG) with Network Security Groups (NSG)**

---

## ğŸ“˜ Lab Overview

In this lab, we explore **Application Security Groups (ASG)** and understand **why they are critical in modern, scalable Azure architectures**.

We start by identifying the **limitations of IP-based NSG rules**, then introduce ASGs as an abstraction layer that enables **role-based, dynamic, and maintainable security rules** â€” without relying on static IP addresses.

This lab demonstrates how ASGs work together with NSGs to secure **Web-to-Database traffic** in a **two-tier architecture**.

---

## ğŸ¯ Objectives

By the end of this lab, you will understand:

* Why **IP-based NSG rules do not scale**
* What **Application Security Groups (ASG)** are
* How ASGs simplify NSG rule management
* How to associate ASGs with virtual machines
* How NSG rules work using ASGs instead of IP addresses
* Why ASGs are **preferred in enterprise and production environments**

---

## ğŸ§± Architecture Used in This Lab

* **Web VM** (Application Tier)
* **DB VM** (Database Tier)
* **Shared NSG** applied at subnet level
* **Application Security Groups**

  * ASG for Web tier
  * ASG for DB tier

Traffic flow:

```
Internet â†’ Web VM â†’ DB VM (MySQL)
```

---

## ğŸ”¹ Part 1: Problem with Traditional IP-Based NSG Rules

### âŒ Static IP-Based Security Rules

Initially, the NSG rules were configured using **private IP addresses** of the Web VM and DB VM.

ğŸ“¸ **Screenshot: NSG using static IP addresses**
![Static IP based NSG rules](https://raw.githubusercontent.com/PunitAnand-SRE/az-104-labs/main/18-azure-application-security-groups-asg-with-nsg/screenshots/01-nsg-using-static-ip-addresses-for-web-and-db-traffic.png)

### âš ï¸ Why This Is a Problem

Using IP addresses in NSG rules causes several issues:

* VM IPs can change (redeployments, scaling, re-creation)
* Adding a new Web VM requires **manual NSG updates**
* High operational overhead
* Error-prone and hard to audit
* Poor scalability in auto-scaling scenarios

ğŸ‘‰ **This approach does not work well in real-world enterprise environments.**

---

## ğŸ”¹ Part 2: What Is an Application Security Group (ASG)?

### âœ… Definition

**Application Security Groups (ASG)** allow you to group Azure VMs based on their **application role** (Web, App, DB), rather than their IP address.

ASGs act as **logical identity labels** that can be referenced inside NSG rules.

### ğŸ”‘ Key Concept

> **NSGs control traffic, ASGs define who the traffic applies to**

---

## ğŸ”¹ Part 3: Creating ASGs for Application Tiers

We created two ASGs:

* **asg-az104-cind-web** â†’ for Web tier VMs
* **asg-az104-cind-db** â†’ for Database tier VMs

ğŸ“¸ **Screenshot: ASGs created for Web and DB tiers**
![ASG creation](https://raw.githubusercontent.com/PunitAnand-SRE/az-104-labs/main/18-azure-application-security-groups-asg-with-nsg/screenshots/02-application-security-groups-created-for-web-and-db-tiers.png)

### ğŸ§  Why This Matters

Instead of saying:

> â€œAllow traffic from 10.0.1.4â€

We now say:

> â€œAllow traffic from **Web tier**â€

This is **role-based security**, not IP-based security.

---

## ğŸ”¹ Part 4: Associating ASGs with Virtual Machines

Each VM network interface was associated with the appropriate ASG:

* Web VM â†’ **asg-az104-cind-web**
* DB VM â†’ **asg-az104-cind-db**

ğŸ“¸ **Screenshot: ASGs associated with VMs**
![ASG association](https://raw.githubusercontent.com/PunitAnand-SRE/az-104-labs/main/18-azure-application-security-groups-asg-with-nsg/screenshots/03-asg-associated-with-web-vm-and-db-vm.png)

### ğŸ” Important Notes

* ASGs are associated at the **NIC level**
* A VM can belong to **multiple ASGs**
* ASG association does **not interrupt traffic**

---

## ğŸ”¹ Part 5: Updating NSG Rules to Use ASGs

The NSG rule was updated to:

* **Source** â†’ ASG (Web tier)
* **Destination** â†’ ASG (DB tier)
* **Port** â†’ 3306 (MySQL)

ğŸ“¸ **Screenshot: NSG rules using ASGs**
![NSG with ASG](https://raw.githubusercontent.com/PunitAnand-SRE/az-104-labs/main/18-azure-application-security-groups-asg-with-nsg/screenshots/04-nsg-rules-updated-to-use-asg-instead-of-ip-addresses.png)

### âœ… Result

* Web VMs can connect to DB VMs
* No IP addresses used
* Security is **clean, readable, and scalable**

---

## ğŸ” Security Flow After ASG Implementation

| Source Tier  | Destination Tier | Allowed | Reason              |
| ------------ | ---------------- | ------- | ------------------- |
| Internet     | Web              | âœ…       | HTTP allowed        |
| Internet     | DB               | âŒ       | No ASG match        |
| Web ASG      | DB ASG           | âœ…       | Explicit NSG rule   |
| Any Other VM | DB               | âŒ       | Not part of Web ASG |

---

## ğŸš€ Why ASGs Are Critical in Production

### âœ” Scalability

* Add or remove VMs without touching NSG rules

### âœ” Reduced Operational Risk

* No IP management
* No broken rules due to IP changes

### âœ” Cleaner Security Design

* Rules are **intent-based**, not network-based

### âœ” DevOps & Auto-Scaling Friendly

* Works seamlessly with VMSS and automation

### âœ” Interview & AZ-104 Favorite

Common question:

> *â€œHow do you manage NSG rules in dynamic environments?â€*

Correct answer:

> **Using Application Security Groups**

---

## ğŸ§  Key Takeaways

* NSGs control **traffic**
* ASGs define **who**
* ASGs eliminate IP dependency
* ASGs are essential for enterprise-grade Azure networking
* This pattern is used in **real production systems**

---

## ğŸ Final Thoughts

This lab demonstrates **how Azure networking evolves**:

1. IP-based rules (basic)
2. Subnet-level NSGs (centralized)
3. ASG-based rules (**enterprise-ready**)

